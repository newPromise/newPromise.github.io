## 错题本客户端需求串讲

### 主进程与渲染进程

electron 中关于进程的介绍： [主进程与渲染进程](https://electronjs.org/docs/tutorial/application-architecture#main-and-renderer-processes)

#### 主进程：

运行 package.json 中的 main 脚本的进程被称为 主进程， 在 electron 中， 主进程有且只有一个。

主进程用于创建窗口以及和与原生的 GUI 进行交互, 对于对于应用窗口的一些操作。

主进程下面有多个渲染进程， 当主进程销毁的时候， 渲染进程也会停止。

#### 渲染进程

渲染进程用于运行 web 页面，打开的应用程序中的各个web 页面都运行在单独的渲染进程里面。

渲染进行不能直接调用原生 GUI 的一些 api， 如果想要调用， 需要和主进程之间进行通讯， 让主进程来调用原生 GUI 的一些 api。

#### 主进程与渲染进程之间的通讯：

在主进程与渲染进程之间通讯的方式有两种：

* 通过ipcRenderer 以及 ipcMain 进行消息通讯
* 使用 remote 模块进行 RPC 方式进行通讯

使用 `ipcRender` 以及 `ipcMain` 之间进行主线程与渲染线程之间的通讯，这两种方式的相同点和不同之处在于：

相同点：

用于监听，接收， 以及发送消息的方法， 都属于 node.js 中`EventEmitter` 的实例，

不同点：

`ipcRender` 用于渲染线程， 用于处理主线程发送给渲染线程的消息， 并且可以发送消息给主线程

`ipcMain` 用于主进程， 可以监听到渲染线程发送来的消息， 但是不能主动发送消息给渲染线程。

remote 模块

当页面涉及到调用原生GUI， 例如一个 dialog 或者 菜单的时候， 如果使用 ipc 模块， 需要使用 ipcRender 向主线程发送消息， 通过 ipcMain 接收到消息之后调用原生 GUI， 通过使用 remote 模块可以在渲染线程中调用 GUI

### 导出到PDF

点击导出所选学生之后， 出现来导出的弹窗， 点击弹窗中的导出按钮之后， 调用 `ipcRender` 向主线程发送消息， 传递参数为导出的相关信息：

```js
ipcRenderer.send('export-students', data);
```

从选中导出到最终导出完成， 最终流程如下：

点击导出按钮之后， 渲染进程触发 `export-students` ， 主进程监听到方法被触发之后：

![image-20190315174436059](/Users/ixiaoyun/Library/Application Support/typora-user-images/image-20190315174436059.png)

调用 exportSingle 之后， 调用 `getNextExport`  方法

![image-20190315175814606](/Users/ixiaoyun/Library/Application Support/typora-user-images/image-20190315175814606.png)

当现在没有正在导出的数据并且导出的数据列表不为空的时候， 调用 `getNextRequestStudents`   方法来获取需要导出学生的数组；

获取到学生之后， 调用 `fetchCuotiInfo` 方法：

![image-20190315180929846](/Users/ixiaoyun/Library/Application Support/typora-user-images/image-20190315180929846.png)

通过 `fetchCuotiInfo` 方法发起请求获取错题数据， 获取到数据之后， 调用 `getNextStudent` 方法进行数据组合， 最终返回组合之后的数据。

当返回数据之后， 调用 `setupBackgroundWindow` 方法用来创建窗口，当创建完成之后， `did-finish-load` 方法被触发之后， 发送 `do-export` 事件

![image-20190315183408501](/Users/ixiaoyun/Library/Application Support/typora-user-images/image-20190315183408501.png)

app.vue 中接受到 do-export 之后， 调用 exportData 方法， 触发 preparePrintToPdf 函数， 用于封装导出 pdf 前的准备工作。

![image-20190315193956379](/Users/ixiaoyun/Library/Application Support/typora-user-images/image-20190315193956379.png)

调用 preparePrintToPdf 之后

![image-20190315193604678](/Users/ixiaoyun/Library/Application Support/typora-user-images/image-20190315193604678.png)

调用 printToPDF 函数 send print-pdf-puppeteer

print-pdf-puppeteer   print-pdf-puppeteer-done  调用 onPrintPdfByPuppeteerDone